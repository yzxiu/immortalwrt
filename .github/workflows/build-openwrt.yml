name: Build OpenWrt (ImmortalWrt)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target make target, e.g., world"
        required: false
        default: "world"
  push:
    branches:
      - openwrt-23.05
  pull_request:
    branches:
      - openwrt-23.05

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    container:
      image: q946666800/openwrt-build:v23.05_3
      options: --mount type=bind,source=/mnt,target=/mnt
    strategy:
      fail-fast: false  # æŸä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°ç»§ç»­ç¼–è¯‘
      matrix:
        platform:
          - name: mt3000
            config: .config.mt3000
          - name: tr3000
            config: .config.tr3000
          - name: x64
            config: .config.x64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ç¼“å­˜ dl ç›®å½•ï¼ˆä¸‹è½½çš„æºç åŒ… - è·¨å¹³å°å…±äº«ï¼‰
        uses: actions/cache@v4
        with:
          path: dl
          key: dl-${{ runner.os }}-${{ hashFiles('feeds.conf.default') }}
          restore-keys: |
            dl-${{ runner.os }}-

      - name: ç¼“å­˜ feeds ç›®å½•ï¼ˆè·¨å¹³å°å…±äº«ï¼‰
        uses: actions/cache@v4
        with:
          path: |
            feeds
            package/feeds
          key: feeds-${{ runner.os }}-${{ hashFiles('feeds.conf.default') }}
          restore-keys: |
            feeds-${{ runner.os }}-

      - name: æ˜¾ç¤ºå·¥å…·ç‰ˆæœ¬å’Œç£ç›˜ç©ºé—´
        run: |
          gcc --version
          make --version
          python3 --version
          echo "=== åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥ ==="
          df -h
          echo "=== æŒ‚è½½ç©ºé—´æ£€æŸ¥ ==="
          ls -la /mnt/ || echo "æŒ‚è½½ç‚¹ä¸å­˜åœ¨"
          echo "=== æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶ ==="
          # æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          # æ¸…ç†å¯èƒ½çš„æ—¥å¿—æ–‡ä»¶
          sudo find /var/log -name "*.log" -size +10M -delete 2>/dev/null || true
          echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
          df -h

      - name: è®¾ç½®ç¼–è¯‘ç›®å½•åˆ°æŒ‚è½½ç©ºé—´
        run: |
          echo "=== è®¾ç½®ç¼–è¯‘ç›®å½•åˆ°æŒ‚è½½ç©ºé—´ ==="
          # æ£€æŸ¥æŒ‚è½½ç‚¹æƒé™
          ls -la /mnt/ || echo "æŒ‚è½½ç‚¹ä¸å­˜åœ¨æˆ–æ— æƒé™"
          # æ¸…ç©ºæŒ‚è½½ç©ºé—´
          sudo rm -rf /mnt/openwrt-build/* 2>/dev/null || true
          # ä½¿ç”¨sudoåˆ›å»ºç›®å½•å¹¶è®¾ç½®æƒé™
          sudo mkdir -p /mnt/openwrt-build/build_dir
          sudo mkdir -p /mnt/openwrt-build/staging_dir
          sudo mkdir -p /mnt/openwrt-build/tmp
          sudo chown -R $(whoami):$(whoami) /mnt/openwrt-build
          sudo chmod -R 755 /mnt/openwrt-build
          echo "âœ“ æˆåŠŸåˆ›å»ºæŒ‚è½½ç©ºé—´ç›®å½•"
          # åˆ›å»ºç¬¦å·é“¾æ¥å°†ç¼–è¯‘ç›®å½•é‡å®šå‘åˆ°æŒ‚è½½ç©ºé—´
          ln -sf /mnt/openwrt-build/build_dir build_dir
          ln -sf /mnt/openwrt-build/staging_dir staging_dir
          ln -sf /mnt/openwrt-build/tmp tmp
          echo "=== æŒ‚è½½ç©ºé—´è®¾ç½®å®Œæˆ ==="
          ls -la /mnt/openwrt-build/
          df -h /mnt/

      - name: æ›´æ–°å’Œå®‰è£… feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: é…ç½®
        run: |
          # å¤åˆ¶å¯¹åº”å¹³å°çš„é…ç½®æ–‡ä»¶
          cp ${{ matrix.platform.config }} .config
          # ç”Ÿæˆå®Œæ•´é…ç½®
          make defconfig

      - name: ä¸‹è½½æºç åŒ…
        run: |
          make download -j$(nproc) V=s

      # - name: ç¼–è¯‘å‰æ·±åº¦æ¸…ç†
      #   run: |
      #     echo "=== ç¼–è¯‘å‰æ·±åº¦æ¸…ç† ==="
      #     # æ¸…ç†å¯èƒ½çš„ç¼–è¯‘æ®‹ç•™
      #     # rm -rf build_dir 2>/dev/null || true
      #     # rm -rf staging_dir 2>/dev/null || true
      #     # rm -rf tmp 2>/dev/null || true
      #     # æ¸…ç†ç³»ç»Ÿç¼“å­˜
      #     sudo apt-get clean 2>/dev/null || true
      #     sudo rm -rf /var/cache/apt/archives/* 2>/dev/null || true
      #     echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
      #     df -h

      - name: ç¼–è¯‘
        run: |
          TARGET="${{ github.event.inputs.target }}"
          if [ -z "$TARGET" ]; then TARGET=world; fi
          echo "å¼€å§‹ç¼–è¯‘: make $TARGET -j$(nproc)"
          make $TARGET -j$(nproc) V=s

      - name: æ£€æŸ¥ç¼–è¯‘äº§ç‰©å’Œç¼“å­˜å¤§å°
        if: always()
        run: |
          echo "=== å·¥ä½œç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å¤¹å¤§å° ==="
          du -sh */ 2>/dev/null | sort -hr || echo "æ— æ–‡ä»¶å¤¹"
          echo ""
          echo "=== ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
          df -h

      - name: æ¸…ç† build_dir èŠ‚çœç©ºé—´
        if: success()
        run: |
          echo "=== æ¸…ç†å‰ build_dir å¤§å° ==="
          if [ -d build_dir ]; then
            du -sh build_dir 2>/dev/null || echo "æ— æ³•è·å– build_dir å¤§å°"
            echo "åˆ é™¤ build_dir æ–‡ä»¶å¤¹ä»¥èŠ‚çœç©ºé—´..."
            rm -rf build_dir
            echo "âœ“ build_dir å·²åˆ é™¤"
          else
            echo "build_dir æ–‡ä»¶å¤¹ä¸å­˜åœ¨"
          fi
          echo "=== æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
          df -h

      # - name: æ·±åº¦æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
      #   if: success()
      #   run: |
      #     echo "=== æ·±åº¦æ¸…ç†å¼€å§‹ ==="
      #     # æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
      #     rm -rf build_dir 2>/dev/null || true
      #     rm -rf staging_dir 2>/dev/null || true
      #     rm -rf tmp 2>/dev/null || true
      #     rm -rf logs 2>/dev/null || true
      #     # æ¸…ç†ç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸­é—´æ–‡ä»¶
      #     find . -name "*.o" -delete 2>/dev/null || true
      #     find . -name "*.a" -delete 2>/dev/null || true
      #     find . -name "*.so" -delete 2>/dev/null || true
      #     find . -name "*.tmp" -delete 2>/dev/null || true
      #     # æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
      #     sudo rm -rf /tmp/* 2>/dev/null || true
      #     sudo rm -rf /var/tmp/* 2>/dev/null || true
      #     echo "=== æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
      #     df -h

      - name: æå–å›ºä»¶æ–‡ä»¶
        if: success()
        run: |
          mkdir -p firmware
          case "${{ matrix.platform.name }}" in
            mt3000)
              if [ -f bin/targets/mediatek/filogic/immortalwrt-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin ]; then
                cp bin/targets/mediatek/filogic/immortalwrt-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin firmware/
                echo "âœ“ MT3000 å›ºä»¶å·²æå–"
              else
                echo "âœ— MT3000 å›ºä»¶æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              fi
              ;;
            tr3000)
              if [ -f bin/targets/mediatek/filogic/immortalwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin ]; then
                cp bin/targets/mediatek/filogic/immortalwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin firmware/
                echo "âœ“ TR3000 å›ºä»¶å·²æå–"
              else
                echo "âœ— TR3000 å›ºä»¶æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              fi
              ;;
            x64)
              if [ -f bin/targets/x86/64/immortalwrt-x86-64-generic-squashfs-combined-efi.img.gz ]; then
                cp bin/targets/x86/64/immortalwrt-x86-64-generic-squashfs-combined-efi.img.gz firmware/
                echo "âœ“ x64 å›ºä»¶å·²æå–"
              else
                echo "âœ— x64 å›ºä»¶æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              fi
              ;;
          esac
          echo "=== å›ºä»¶æ–‡ä»¶åˆ—è¡¨ ==="
          ls -lh firmware/

      - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶ï¼ˆç”¨äº releaseï¼‰
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.platform.name }}
          path: firmware/*
          if-no-files-found: error

      - name: ä¸Šä¼ å®Œæ•´ç¼–è¯‘äº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-bin-${{ matrix.platform.name }}-${{ github.run_id }}
          path: bin
          if-no-files-found: warn

      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-logs-${{ matrix.platform.name }}-${{ github.run_id }}
          path: |
            logs
          if-no-files-found: ignore

  release:
    needs: build
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ä¸‹è½½æ‰€æœ‰å›ºä»¶æ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          pattern: firmware-*
          path: ./all-firmware
          merge-multiple: false

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        run: |
          mkdir -p release-files
          # ä»å„å¹³å°çš„ artifact ä¸­å¤åˆ¶å›ºä»¶åˆ°ç»Ÿä¸€ç›®å½•
          find ./all-firmware -type f \( -name "*.bin" -o -name "*.img.gz" \) | while read file; do
            cp "$file" release-files/
          done
          echo "=== å‡†å¤‡å‘å¸ƒçš„å›ºä»¶åˆ—è¡¨ ==="
          ls -lh release-files/
          # éªŒè¯ä¸‰ä¸ªå›ºä»¶æ–‡ä»¶éƒ½å­˜åœ¨
          [ -f release-files/immortalwrt-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin ] || (echo "âŒ MT3000 å›ºä»¶ç¼ºå¤±" && exit 1)
          [ -f release-files/immortalwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin ] || (echo "âŒ TR3000 å›ºä»¶ç¼ºå¤±" && exit 1)
          [ -f release-files/immortalwrt-x86-64-generic-squashfs-combined-efi.img.gz ] || (echo "âŒ x64 å›ºä»¶ç¼ºå¤±" && exit 1)
          echo "âœ… æ‰€æœ‰å›ºä»¶æ–‡ä»¶å·²å°±ç»ª"

      - name: ç”Ÿæˆ Release Tag
        id: tag
        run: |
          echo "release_tag=ImmortalWrt-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ å›ºä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: ${{ steps.tag.outputs.release_tag }}
          body: |
            ## ğŸ‰ ImmortalWrt è‡ªåŠ¨æ„å»ºå›ºä»¶
            
            **æ„å»ºæ—¶é—´**: `${{ steps.tag.outputs.release_tag }}`
            **æºä»£ç åˆ†æ”¯**: `${{ github.ref_name }}`
            **Commit**: `${{ github.sha }}`
            
            ### ğŸ“¦ åŒ…å«çš„å›ºä»¶
            
            | è®¾å¤‡ | å›ºä»¶æ–‡ä»¶ |
            |------|---------|
            | **GL.iNet GL-MT3000** | `immortalwrt-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin` |
            | **Cudy TR3000 v1** | `immortalwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin` |
            | **x86-64 (é€šç”¨)** | `immortalwrt-x86-64-generic-squashfs-combined-efi.img.gz` |
            
            ### ğŸ“ ä½¿ç”¨è¯´æ˜
            
            - é€šè¿‡ SSH å°†å›ºä»¶ä¸Šä¼ åˆ° `/tmp`ï¼Œæ‰§è¡Œ `sysupgrade -c /tmp/<å›ºä»¶æ–‡ä»¶å>.bin` è¿›è¡Œå‡çº§å¹¶ä¿ç•™é…ç½®
            
            âš ï¸ **æ³¨æ„**: å‡çº§å‰è¯·å¤‡ä»½é‡è¦é…ç½®ï¼
          files: |
            release-files/immortalwrt-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin
            release-files/immortalwrt-mediatek-filogic-cudy_tr3000-v1-squashfs-sysupgrade.bin
            release-files/immortalwrt-x86-64-generic-squashfs-combined-efi.img.gz
          draft: false
          prerelease: false

