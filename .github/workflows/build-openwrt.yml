name: Build OpenWrt (ImmortalWrt)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target make target, e.g., world"
        required: false
        default: "world"
  push:
    branches:
      - openwrt-23.05
  pull_request:
    branches:
      - openwrt-23.05

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 安装构建依赖（参考 OpenWrt 官方文档）
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget

      - name: 显示工具版本
        run: |
          gcc --version
          make --version
          python3 --version

      - name: 更新和安装 feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置
        run: |
          # 如果已有 .config 文件则备份
          if [ -f .config ]; then
            cp .config .config.backup
          fi
          # 生成默认配置
          make defconfig

      - name: 下载源码包
        run: |
          make download -j$(nproc) V=s

      - name: 编译
        run: |
          TARGET="${{ github.event.inputs.target }}"
          if [ -z "$TARGET" ]; then TARGET=world; fi
          echo "开始编译: make $TARGET -j$(nproc)"
          make $TARGET -j$(nproc) V=s

      - name: 检查编译产物
        if: always()
        run: |
          echo "=== 编译产物大小 ==="
          du -sh bin 2>/dev/null || echo "bin 目录不存在"
          echo "=== 磁盘使用情况 ==="
          df -h

      - name: 上传编译产物
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-bin-${{ github.run_id }}
          path: bin
          if-no-files-found: warn

      - name: 上传编译日志（失败时）
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-logs-${{ github.run_id }}
          path: |
            logs
          if-no-files-found: ignore

